let recognition=null,isVoiceProcessing=!1,isVoiceListening=!1,targetLangCode="en-US",musicTokenizer=null,musicModel=null,currentMode="chat",chatHistory=[],wllama=null,isModelDownloaded=!1,isModelLoaded=!1,isLocalActive=!1,isStarted=!1,isGenerating=!1,abortController=null,stopSignal=!1,isMenuOpen=!1,activeApp=null,searchTimeout=null,currentStorePage=1,isStoreLoading=!1,hasMoreStoreApps=!0,currentStoreQuery="",currentStoreCategory="All";const STORE_LIMIT=12;function filterStore(e,t){document.querySelectorAll(".store-filter-btn").forEach((e=>e.classList.remove("active"))),t&&t.classList.add("active"),currentStoreCategory=e,fetchStoreApps(currentStoreQuery,!1)}function renderFixedApps(){const e=document.getElementById("fixed-apps-list");e.innerHTML="",0!==fixedApps.length?(e.style.display="flex",fixedApps.forEach(((t,o)=>{const n=document.createElement("div");n.className="fixed-app-item",n.title=t.title,n.onclick=()=>loadAppDetails(t.id),n.innerHTML=getAppIconHtml(t)+`\n                    <button class="fixed-delete-btn" onclick="removeFixedApp(event, ${o})" title="Remove">\n                        <i class="ri-close-line"></i>\n                    </button>\n                `,e.appendChild(n)}))):e.style.display="none"}function saveCurrentApp(){activeApp&&(fixedApps.some((e=>e.id===activeApp.id))?showToast("Already added to favorites."):(fixedApps.push({id:activeApp.id,title:activeApp.title,icon_url:activeApp.icon_url}),localStorage.setItem("ISAI_FIXED_APPS",JSON.stringify(fixedApps)),renderFixedApps(),showToast("Saved to favorites!")))}function toggleStoreMenu(){const e=document.getElementById("store-panel"),t=document.getElementById("icon-menu"),o=document.getElementById("btn-menu"),n=document.getElementById("prompt-input");isMenuOpen=!isMenuOpen,isMenuOpen?(e.classList.add("open"),t.className="ri-draggable text-xl",o.classList.add("text-white"),fetchStoreApps("",!1),n.focus()):(e.classList.remove("open"),t.className="ri-draggable text-xl",o.classList.remove("text-white"))}function handleInput(e){if(e.style.height="auto",e.style.height=e.scrollHeight+"px",isMenuOpen){const t=e.value.trim();clearTimeout(searchTimeout),searchTimeout=setTimeout((()=>{fetchStoreApps(t,!1)}),500)}else"app"===currentMode&&fetchApps(e.value.trim())}async function fetchStoreApps(e,t=!1){const o=document.getElementById("store-loader"),n=document.getElementById("store-grid");if(t||(currentStorePage=1,hasMoreStoreApps=!0,currentStoreQuery=e,n.innerHTML="",n.scrollTop=0),!hasMoreStoreApps||isStoreLoading)return;isStoreLoading=!0,o.classList.remove("hidden");let a=`re_store.php?action=list_apps&limit=${STORE_LIMIT}&page=${currentStorePage}`;e?a+=`&q=${encodeURIComponent(e)}`:"All"!==currentStoreCategory&&(a+=`&cat=${encodeURIComponent(currentStoreCategory)}`);try{const e=await fetch(a),s=(await e.json()).data||[];if(o.classList.add("hidden"),s.length>0)renderStoreItems(s,n),s.length<STORE_LIMIT?hasMoreStoreApps=!1:currentStorePage++;else if(hasMoreStoreApps=!1,!t){const e="undefined"!=typeof T&&T.no_results?T.no_results:"No apps found.";n.innerHTML=`<div class="col-span-full text-center text-gray-500 text-[10px] py-4">${e}</div>`}}catch(e){o.classList.add("hidden"),isStoreLoading=!1,t||(n.innerHTML='<div class="col-span-full text-center text-gray-500 text-[10px] py-4">Failed to load.</div>')}finally{isStoreLoading=!1}}async function loadAppDetails(e){showLoader(!0);try{const t=await fetch(`re_store.php?action=detail_app&id=${e}`),o=await t.json();if(o&&!o.error){activeApp=o,activateAppMode();const e=(o.category||"").toLowerCase();"code"===e?setMode("code"):"image"===e?setMode("image"):"music"===e?setMode("music"):"video"===e?setMode("video"):"blog"===e?setMode("blog"):setMode("chat"),showToast(`App Loaded: ${o.title}`)}else showToast("App not found")}catch(e){showToast("Error loading app details")}finally{showLoader(!1)}}async function executeAction(e="right"){if("string"!=typeof e&&(e="right"),"voice"===currentMode||"translate"===currentMode){if(isVoiceProcessing)return;if(isVoiceListening){if(translationSide===e)return isVoiceListening=!1,stopVoiceMode(!1),void showToast("Listening Paused");recognition&&(recognition.abort(),recognition=null),isVoiceListening=!1}return translationSide=e,void setTimeout((()=>{try{isVoiceListening=!0,setVoiceState(e,"recording"),recognition?(updateRecognitionLang(),recognition.start()):initVoiceMode()}catch(e){initVoiceMode()}}),100)}const t=document.getElementById("prompt-input"),o=t.value.trim();if(isMenuOpen&&o)fetchStoreApps(o);else{if("app"===currentMode)return t.value="",t.style.height="auto",void fetchApps(o);if("community"!==currentMode){if(o){window.currentImagePrompt=o,window.savedPrompt=o,startExperience(),"function"==typeof closePreview&&closePreview(),t.value="",t.style.height="auto",showLoader(!0),appendMsg("user",o),abortController&&abortController.abort(),abortController=new AbortController,stopSignal=!1;try{if(activeApp){const a=activeApp.api_url&&""!==activeApp.api_url.trim(),s=(activeApp.category||"").toLowerCase();if(a&&!["image","code","music","video","blog","character"].includes(s))return void await executeAppLogic(o)}if("translate"===currentMode){const i=document.getElementById("trans-select-left").value,r=document.getElementById("trans-select-right").value;let l="left"===e?i:r,c="left"===e?r:i;const d=await fetch("?action=ai_translate",{method:"POST",body:JSON.stringify({text:o,target_lang:c,source_lang:l}),signal:abortController.signal}),p=await d.json();if("LIMIT_REACHED"===p.error){showToast("Limit reached. Local Translation..."),isModelLoaded||await startDownload();const m=[{role:"system",content:`Translate the following text to ${c}. Output ONLY the translated text.`},{role:"user",content:o}];let u="";const g=appendMsg("ai","..."),h=langMap[c]||"en-US";await runLocalInference(m,(e=>{stopSignal||(u+=e,g.innerHTML=`<div class="text-lg font-bold text-blue-300 leading-relaxed">${u}</div>`,scrollBottom())})),stopSignal||speakText(u,h)}else if(p.error)appendMsg("error",p.error);else{let f={text:p.response};try{let w=p.response.replace(/```json/g,"").replace(/```/g,"").trim();f=JSON.parse(w)}catch(x){f.text=p.response}appendMsg("ai",`<div class="text-lg font-bold text-blue-300 leading-relaxed">${f.text}</div>`);const y=langMap[c]||"en-US";speakText(f.text,y)}}else if("video"===currentMode){let b=o;activeApp&&activeApp.system_prompt&&(b=`${activeApp.system_prompt}, ${o}`);const v="2x2 grid "+b,I=await fetch("?action=ai_video",{method:"POST",body:JSON.stringify({prompt:v,watermark:!1}),signal:abortController.signal}),L=await I.json();L.error?appendMsg("error","Video Error: "+L.error):(generateGifFromGrid(L.b64,L.translated||b),["app-container","welcome-msg","center-app-name"].forEach((e=>{const t=document.getElementById(e);t&&(t.style.display="none")})))}else if("image"===currentMode){let E=o;activeApp&&activeApp.system_prompt&&(E=`${activeApp.system_prompt}, ${o}`);const M=document.getElementById("image-ratio-value")?.value||"square",T=await fetch("?action=ai_image",{method:"POST",body:JSON.stringify({prompt:E,ratio:M}),signal:abortController.signal});let A=await T.json();A.error?appendMsg("error","Image Error: "+A.error):(window.currentImagePrompt=E,appendImg(A.b64,E),openPreview("data:image/png;base64,"+A.b64),["app-container","welcome-msg","center-app-name"].forEach((e=>{const t=document.getElementById(e);t&&(t.style.display="none")})))}else if("music"===currentMode){let S=o;activeApp&&activeApp.system_prompt&&(S=`${activeApp.system_prompt}, ${o}`),await generateMusic(S)}else if("search"===currentMode){let C=await fetch("?action=search_data",{method:"POST",body:JSON.stringify({prompt:o}),signal:abortController.signal}),B=await C.json();if(B.results&&B.results.length>0){const _=B.results.slice(0,5);let k=_.map(((e,t)=>`[문서 ${t+1}] ${e.content}`)).join("\n");const P=await fetch("?action=search_synthesis",{method:"POST",body:JSON.stringify({query:o,context:k}),signal:abortController.signal}),F=await P.json();if("LIMIT_REACHED"===F.error){showToast("Server limit reached. Local Summarizing..."),isModelLoaded||await startDownload();const N=appendMsg("ai","...");let O="";const D=[{role:"system",content:"넌 천재 요약봇."},{role:"user",content:`${k}\n위 내용을 기반으로 답변해줘.`}];await runLocalInference(D,(e=>{stopSignal||(O+=e,N.innerHTML=parseMarkdownLocal(O),scrollBottom())})),addSourcesToBubble(N,_)}else addSourcesToBubble(appendMsg("ai",F.html||"Thinking..."),_)}else appendMsg("ai","검색 결과가 없습니다.")}else{let H=o,j=chatHistory,R="undefined"!=typeof SYSTEM_PROMPTS&&SYSTEM_PROMPTS[LANG]?SYSTEM_PROMPTS[LANG]:"You are a helpful AI.";if(activeApp&&(activeApp.system_prompt&&(R=activeApp.system_prompt),"Code"===activeApp.category&&(H=`System: ${R}\n\nUser Request: ${o}`)),"blog"===currentMode&&(H=`Topic: "${o}". Instructions: ${R}. Lang: ${"ko"===LANG?"Korean":"English"}. Add [[IMG: keyword]] tags.`,j=[]),isModelLoaded&&isLocalActive){const U=[{role:"system",content:R},...j.slice(-4),{role:"user",content:H}];let G="";const V=appendMsg("ai","...");await runLocalInference(U,(e=>{stopSignal||(G+=e,V.innerHTML=parseMarkdownLocal(G),scrollBottom())})),n(G),chatHistory.push({role:"user",content:o},{role:"assistant",content:G}),"blog"===currentMode&&await processBlogImages(V)}else{const W=await fetch("?action=ai_chat",{method:"POST",body:JSON.stringify({prompt:H,history:j}),signal:abortController.signal}),J=await W.json();if("LIMIT_REACHED"===J.error){showToast("Limit reached. Local Model..."),isModelLoaded||await startDownload();const z=appendMsg("ai","...");let q="";const K=[{role:"system",content:R},...j.slice(-4),{role:"user",content:H}];await runLocalInference(K,(e=>{stopSignal||(q+=e,z.innerHTML=parseMarkdownLocal(q),scrollBottom())})),n(q),chatHistory.push({role:"user",content:o},{role:"assistant",content:q}),"blog"===currentMode&&await processBlogImages(z)}else if(J.response){const Y=appendMsg("ai",parseMarkdownLocal(J.response));n(J.response),chatHistory.push({role:"user",content:o},{role:"assistant",content:J.response}),"blog"===currentMode&&await processBlogImages(Y),"voice"===currentMode&&speakText(J.response)}}}function n(e){window.extractedCodes&&window.extractedCodes.length>0?(codeFiles=[...window.extractedCodes],renderCodeTabs()):"code"===currentMode&&updateCodePanel(e)}}catch(Q){"AbortError"!==Q.name&&appendMsg("error",`오류: ${Q.message}`)}finally{showLoader(!1);const X=document.getElementById("prompt-input");X&&X.focus()}}}else{const Z=document.getElementById("comm-file-input"),ee=document.getElementById("comm-nickname")?document.getElementById("comm-nickname").value:"",te=document.getElementById("comm-password").value;if(!(o||Z.files&&0!==Z.files.length))return showToast("내용이나 이미지를 입력해주세요.");showLoader(!0);try{const oe=new FormData;if(oe.append("content",o),oe.append("password",te),oe.append("nickname",ee),oe.append("type","forum"),Z.files.length>0){const se=await fetch("get_key.php"),ie=(await se.json()).clientId,re=new FormData;re.append("image",Z.files[0]);const le=await fetch("https://api.imgur.com/3/image",{method:"POST",headers:{Authorization:"Client-ID "+ie},body:re}),ce=await le.json();if(!ce.success)throw new Error("Imgur Upload Failed");oe.append("image_url",ce.data.link)}const ne=await fetch("re_store.php?action=create_post",{method:"POST",body:oe}),ae=await ne.json();ae.success?(showToast("Published."),t.value="",handleInput(t),document.getElementById("comm-password").value="","function"==typeof clearCommFile&&clearCommFile(),ae.id?window.location.href="view/"+ae.id+"&type=forum":"function"==typeof switchTab&&(switchTab("forum"),"function"==typeof loadData&&loadData("forum",!0))):showToast("Error: "+ae.error)}catch(de){showToast("Error: "+de.message)}finally{showLoader(!1)}}}}function renderStoreItems(e,t){e.forEach((e=>{const o=document.createElement("div");o.className="store-item",o.title=`${e.title} (Views: ${e.views||0})`,o.onclick=()=>loadAppDetails(e.id),o.innerHTML=getAppIconHtml(e),t.appendChild(o)}))}async function loadAppDetails(e){showLoader(!0);try{const t=await fetch(`re_store.php?action=detail_app&id=${e}`),o=await t.json();if(o&&!o.error){activeApp=o;const e=(o.category||"").toLowerCase();let t="chat";t="image"===e?"image":"code"===e?"code":"chat",setMode(t),activateAppMode(),showToast(`App Loaded: ${o.title}`)}else showToast("App not found")}catch(e){showToast("Error loading app details")}finally{showLoader(!1)}}function activateAppMode(){isMenuOpen&&toggleStoreMenu(),document.getElementById("active-app-status").classList.remove("hidden"),document.getElementById("active-app-name").innerText=activeApp.title,document.getElementById("prompt-input").value="",document.getElementById("chat-box").innerHTML="",activeApp.first_message?appendMsg("ai",activeApp.first_message):appendMsg("ai",`App '${activeApp.title}' started.`)}function exitAppMode(){activeApp=null,document.getElementById("active-app-status").classList.add("hidden"),resetChat(),showToast("App Mode Exited")}async function fetchApps(e=""){const t=document.getElementById("app-grid"),o=document.getElementById("app-container");""!==e&&(t.style.opacity=.5);try{const n=await fetch("?action=search_app",{method:"POST",body:JSON.stringify({prompt:e})});if(n.ok){const a=await n.json();if(t.innerHTML="",a&&a.length>0)if(""===e)t.classList.remove("search-scroll"),o&&o.classList.remove("searching"),a.forEach((e=>{t.appendChild(createAppItem(e))}));else{o&&o.classList.add("searching"),t.classList.add("search-scroll");let e=[...a];for(;e.length<15;)e=e.concat(a);e.forEach((e=>{t.appendChild(createAppItem(e))})),e.forEach((e=>{t.appendChild(createAppItem(e,!0))})),e.forEach((e=>{t.appendChild(createAppItem(e,!0))}))}else{t.classList.remove("search-scroll");const e="undefined"!=typeof T&&T.no_apps?T.no_apps:"No shortcuts.";t.innerHTML=`<p class="text-gray-500 text-xs col-span-full py-2 text-center">${e}</p>`}}}catch(e){}finally{t.style.opacity=1}}function createAppItem(e,t=!1){const o=document.createElement("a");o.href=e.url,o.target="_blank",o.className="app-item",t&&o.classList.add("clone-item"),o.title=e.name;const n=e.icon_url||`https://www.google.com/s2/favicons?sz=64&domain_url=${encodeURIComponent(e.url)}`;return o.innerHTML=`<img src="${n}" alt="${e.name}">`,o}window.addEventListener("DOMContentLoaded",(()=>{initCheckModel(),fetchApps(""),renderFixedApps();const e=document.getElementById("chat-box");e.innerHTML="",e.style.display="flex",e.style.flexDirection="column",e.style.height="100%";const t=document.createElement("div");t.className="chat-spacer",t.style.marginTop="auto",e.appendChild(t);const o=document.createElement("div");o.id="welcome-msg",o.className="self-start bg-white/30 px-4 py-2 rounded-2xl rounded-tl-sm max-w-[85%] mb-2 text-sm break-words animate-pulse-slow w-fit",o.style.display="block";const n=new URLSearchParams(window.location.search),a=n.get("v");o.innerText=a?"How can I help?":"undefined"!=typeof T&&T.welcome?T.welcome:"Hello! How can I help you today?",e.appendChild(o);const s=document.getElementById("btn-chat");s&&s.classList.add("active");const i=document.getElementById("store-grid");i&&i.addEventListener("scroll",(()=>{i.scrollTop+i.clientHeight>=i.scrollHeight-50&&hasMoreStoreApps&&!isStoreLoading&&isMenuOpen&&fetchStoreApps(currentStoreQuery,!0)}));const r=["chat","search","image","code","video","music","blog"];for(const e of r){const t=n.get(e);if(t){o.style.display="none",setMode(e);const n=document.getElementById("prompt-input");n&&(n.value=t,handleInput(n)),setTimeout((()=>{executeAction()}),800);break}}})),window.removeFixedApp=function(e,t){e.stopPropagation(),fixedApps.splice(t,1),localStorage.setItem("ISAI_FIXED_APPS",JSON.stringify(fixedApps)),renderFixedApps(),showToast("Removed from favorites.")};let fixedApps=JSON.parse(localStorage.getItem("ISAI_FIXED_APPS")||"[]");function getAppIconHtml(e){const t=e.title||"App",o=t.charAt(0).toUpperCase(),n=["bg-gradient-to-br from-blue-500 to-cyan-500","bg-gradient-to-br from-purple-500 to-pink-500","bg-gradient-to-br from-emerald-500 to-green-500","bg-gradient-to-br from-orange-500 to-red-500","bg-gradient-to-br from-indigo-500 to-purple-500","bg-gradient-to-br from-teal-500 to-emerald-500"];return`<div class="app-letter-icon ${n[t.charCodeAt(0)%n.length]}">${o}</div>${e.icon_url&&""!==e.icon_url.trim()?`<img src="${e.icon_url}" \n                class="w-full h-full object-cover rounded-xl relative z-10" \n                onload="this.style.opacity=1; this.previousElementSibling.style.display='none'" \n                onerror="this.style.display='none'">`:""}`}function startExperience(){isStarted||(document.body.classList.add("started"),document.getElementById("custom-scrollbar").style.display="block",isStarted=!0,setTimeout(scrollBottom,600))}let translationSide="right";const langMap={English:"en-US",Korean:"ko-KR",Japanese:"ja-JP",Chinese:"zh-CN",Spanish:"es-ES",French:"fr-FR",German:"de-DE",Russian:"ru-RU"};function setVoiceState(e,t){const o=document.getElementById("btn-submit-left"),n=document.getElementById("btn-submit"),a=document.getElementById("icon-submit-left"),s=document.getElementById("icon-submit");if(!o||!n)return;if(o.className="w-9 h-9 items-center justify-center flex-shrink-0 mr-2 transition-all duration-300 rounded-full",n.className="btn-submit w-9 h-9 flex items-center justify-center flex-shrink-0 transition-all duration-300",o.style.backgroundColor="rgba(128,128,128,0.1)",n.style.backgroundColor="",n.style.color="",o.style.opacity="1",n.style.opacity="1",o.style.pointerEvents="auto",n.style.pointerEvents="auto",o.style.display="translate"!==currentMode?"none":"flex",a.className="ri-voiceprint-line text-lg",s.className="ri-voiceprint-line text-lg","idle"===t)return;const i="left"===e?o:n,r="left"===e?a:s,l="left"===e?n:o;l.style.opacity="0.3",l.style.pointerEvents="none","recording"===t?(r.className="ri-voiceprint-line text-lg animate-mic-breath",i.style.backgroundColor="#ef4444",i.style.color="white"):"processing"===t&&(r.className="ri-voiceprint-line text-lg animate-spin",i.style.backgroundColor="",i.style.color="")}function updateSubmitIcon(e,t="right"){setVoiceState(t,"mic"===e||"default"===e?"idle":e)}function showPopup(e,t,o){const n=document.getElementById("modal-layer");document.getElementById("modal-title").innerText=e,document.getElementById("modal-msg").innerText=t,document.getElementById("modal-cancel").innerText=T.btn_cancel,document.getElementById("modal-confirm").innerText=T.btn_confirm;const a=document.getElementById("modal-confirm"),s=document.getElementById("modal-cancel"),i=a.cloneNode(!0),r=s.cloneNode(!0);a.parentNode.replaceChild(i,a),s.parentNode.replaceChild(r,s),i.onclick=()=>{closePopup(),o()},r.onclick=()=>{closePopup()},n.classList.add("show")}function closePopup(){document.getElementById("modal-layer").classList.remove("show")}function handleLocalToggle(){isModelDownloaded?(isLocalActive=!isLocalActive,!isLocalActive||isModelLoaded?updateLocalBtnState():startDownload()):showPopup(T.popup_title_wifi,T.popup_msg_wifi,startDownload)}function updateLocalBtnState(){const e=document.getElementById("btn-download"),t=e.querySelector("i");isLocalActive?(e.classList.add("text-green-400","active"),t.className="ri-check-line text-xl",e.style.color=""):isModelDownloaded?(e.classList.remove("text-green-400","active"),t.className="ri-check-line text-xl",e.style.color="rgba(255,255,255,0.6)"):(e.classList.remove("text-green-400","active"),t.className="ri-download-line text-xl",e.style.color="rgba(255,255,255,0.3)")}async function startDownload(){const e=document.getElementById("progress-container"),t=document.getElementById("progress-bar");try{e.classList.remove("hidden");const{Wllama:o,LoggerWithoutDebug:n}=window.WllamaObj;wllama||(wllama=new o(MODEL_CONFIG.wasmPaths,{logger:n})),await wllama.loadModelFromUrl(MODEL_CONFIG.url,{n_ctx:2048,progressCallback:({loaded:e,total:o})=>{t.style.width=Math.round(e/o*100)+"%"}}),isModelDownloaded=!0,isModelLoaded=!0,isLocalActive=!0,localStorage.setItem("ISAI_MODEL_DOWNLOADED","true"),e.classList.add("hidden"),updateLocalBtnState()}catch(t){if(t.message&&t.message.includes("initialized"))return isModelDownloaded=!0,isModelLoaded=!0,isLocalActive=!0,localStorage.setItem("ISAI_MODEL_DOWNLOADED","true"),e.classList.add("hidden"),void updateLocalBtnState();e.classList.add("hidden"),alert(t.message),isModelDownloaded=!1,localStorage.removeItem("ISAI_MODEL_DOWNLOADED")}}async function runLocalInference(e,t){isLocalActive&&!isModelLoaded&&await startDownload();const o=await wllama.formatChat(e,!0);await wllama.createCompletion(o,{nPredict:2048,sampling:{temp:.7,top_k:40,top_p:.9},onNewToken:(e,o)=>{if(stopSignal)return!1;t((new TextDecoder).decode(o))}})}function showLoader(e){const t=document.getElementById("loader-overlay");e?t.classList.add("active"):t.classList.remove("active")}function stopGeneration(){isGenerating&&(abortController&&(abortController.abort(),abortController=null),stopSignal=!0,showLoader(!1))}function appendMsg(e,t){const o=document.getElementById("chat-box");if(o.childElementCount>50&&o.removeChild(o.firstElementChild),0===o.childElementCount){const e=document.createElement("div");e.style.marginTop="auto",o.appendChild(e)}let n=!1,a="",s="AI";const i=window.activeApp||activeApp;"ai"===e&&i&&i.icon_url&&(n=!0,a=i.icon_url,s=i.title||"AI");let r=null;if(n){const e=document.createElement("div");e.className="flex w-full items-start gap-2.5 mb-4 animate-fade-in group";const n=document.createElement("div");n.className="relative flex-shrink-0";const i=document.createElement("img");i.src=a,i.className="w-10 h-10 rounded-[14px] object-cover border border-black/5 shadow-sm bg-gray-100";const l=document.createElement("div");l.className="absolute inset-0 w-10 h-10 rounded-[14px] bg-gradient-to-br from-indigo-400 to-purple-500 flex items-center justify-center text-white font-bold text-sm shadow-sm hidden",l.innerText=s.charAt(0).toUpperCase(),i.onerror=function(){this.style.display="none",l.classList.remove("hidden")},n.appendChild(i),n.appendChild(l);const c=document.createElement("div");c.className="flex flex-col gap-1 max-w-[75%]";const d=document.createElement("span");d.className="text-[11px] text-gray-500 font-bold ml-1 opacity-90",d.innerText=s;const p=document.createElement("div");p.className="px-4 py-2.5 rounded-[18px] rounded-tl-none text-sm break-words leading-relaxed shadow-sm relative",p.style.backgroundColor="var(--bg-island, #ffffff)",p.style.color="var(--text-main, #333333)",t.trim().startsWith("<div")||t.trim().startsWith("<p")?p.innerHTML=t:p.innerHTML=t.replace(/\n/g,"<br>"),c.appendChild(d),c.appendChild(p),e.appendChild(n),e.appendChild(c),o.appendChild(e),r=p}else{const n=document.createElement("div");"user"===e?(n.className="self-end px-4 py-2.5 rounded-[18px] rounded-tr-none max-w-[85%] shadow mb-3 text-sm break-words ml-auto",n.style.backgroundColor="var(--accent, #3b82f6)",n.style.color="var(--accent-text, #ffffff)"):(n.className="self-start px-4 py-2.5 rounded-[18px] rounded-tl-none max-w-[85%] mb-3 text-sm break-words leading-relaxed shadow-sm",n.style.backgroundColor="var(--bg-island, #ffffff)",n.style.color="var(--text-main, #333333)"),t.trim().startsWith("<div")||t.trim().startsWith("<p")?n.innerHTML=t:n.innerHTML="ai"===e||"error"===e?t:t.replace(/\n/g,"<br>"),o.appendChild(n),r=n}return scrollBottom(),r}function appendImg(e,t){const o=document.getElementById("chat-box"),n=document.createElement("div");n.className="self-start bg-white p-2 rounded-2xl rounded-tl-sm max-w-sm mb-2 cursor-pointer hover:opacity-90 transition",n.onclick=()=>window.openPreview(e),n.className="bg-[#1a1a1a] border border-white/5 rounded-[26px] p-2 mb-6 shadow-xl",n.innerHTML=`\n    \x3c!-- 이미지: 클릭 시 레이어 팝업 실행 --\x3e\n    <img src="data:image/jpeg;base64,${e}" \n         class="w-full rounded-[20px] block cursor-zoom-in hover:opacity-90 transition-opacity" \n         onclick="openImageModal('data:image/jpeg;base64,${e}', '${t.replace(/'/g,"\\'")}')">\n    \n    \x3c!-- 하단 정보 바 --\x3e\n    <div class="flex justify-between items-center pt-3 px-2 pb-1">\n        <div class="flex flex-col overflow-hidden mr-3">\n            <span class="text-[11px] text-gray-400 font-medium truncate tracking-tight uppercase opacity-50 mb-0.5">Prompt</span>\n            <span class="text-[13px] text-gray-200 font-bold truncate leading-tight">${t}</span>\n        </div>\n        \n        \x3c!-- 다운로드 버튼 --\x3e\n        <a href="data:image/jpeg;base64,${e}" download="isai-art.jpg" \n           class="flex-shrink-0 w-9 h-9 flex items-center justify-center rounded-full bg-white/5 border border-white/5 text-gray-300 hover:bg-white hover:text-black transition-all" \n           onclick="event.stopPropagation()">\n            <i class="ri-download-2-line text-lg"></i>\n        </a>\n    </div>\n`,o.appendChild(n),scrollBottom()}function appendGif(e,t){const o=URL.createObjectURL(e),n=document.getElementById("chat-box"),a=document.createElement("div");a.className="self-start bg-white/30 p-2 rounded-2xl rounded-tl-sm max-w-sm mb-2 cursor-pointer hover:opacity-90 transition",a.onclick=()=>window.openPreview(o),a.innerHTML=`\n        <div class="relative rounded-lg overflow-hidden mb-2">\n            <img src="${o}" class="w-full h-auto object-cover">\n            <div class="absolute top-2 right-2 bg-black/50 text-white text-[10px] px-2 py-0.5 rounded backdrop-blur-sm">GIF</div>\n        </div>\n        <div class="flex justify-end text-[10px] text-gray-400 px-1">\n            <a href="${o}" download="ai_video.gif" class="text-white transition" onclick="event.stopPropagation()">\n                <i class="ri-download-line text-xl"></i>\n            </a>\n        </div>`,n.appendChild(a),scrollBottom()}function addSourcesToBubble(e,t){let o='<div class="border-t border-white/10 mt-3 pt-2 flex flex-wrap gap-2 items-center">';o+='<span class="text-[10px] text-gray-500 mr-1 uppercase tracking-widest font-bold">SOURCE</span>',t.forEach((e=>{const t="https://www.google.com/s2/favicons?sz=64&domain_url="+encodeURIComponent(e.url);o+=`<a href="${e.url}" target="_blank" class="w-6 h-6 rounded bg-white/5 border border-white/10 flex items-center justify-center hover:bg-white/20 transition" title="${e.title}"><img src="${t}" class="w-3.5 h-3.5 opacity-70"></a>`})),o+="</div>",e.innerHTML+=o}function scrollBottom(){const e=document.getElementById("chat-box");requestAnimationFrame((()=>{e.scrollTop=e.scrollHeight}))}function parseMarkdownLocal(e){window.extractedCodes=[],e=e.replace(/</g,"&lt;").replace(/>/g,"&gt;");const t=[];let o=0;return e=(e=(e=(e=(e=(e=(e=e.replace(/```(\w+)?\s*([\s\S]*?)```/g,(function(e,n,a){const s="local-code-"+o++;n=n||"text";let i=a.replace(/&lt;/g,"<").replace(/&gt;/g,">");window.extractedCodes.push({lang:n,content:i,name:`File ${window.extractedCodes.length+1} (${n})`});const r='<div class="code-wrapper my-4 rounded-lg overflow-hidden border border-white/10 bg-[#1e1e1e] shadow-lg"><div class="flex justify-between items-center px-4 py-2 bg-white/5 border-b border-white/5"><span class="text-xs text-gray-200 font-mono uppercase">'+n+'</span><div class="flex items-center gap-3"><button onclick="openFullEditor(\''+s+'\')" class="flex md:hidden items-center gap-1 text-xs text-blue-300 hover:text-blue-200 transition"><i class="ri-code-box-line"></i> Edit</button><button onclick="copyCode(\''+s+'\')" class="flex items-center gap-1 text-xs text-gray-200 hover:text-white transition group"><i class="ri-file-copy-line"></i> <span class="group-hover:underline">Copy</span></button></div></div><div class="relative overflow-x-auto code-scroll"><pre id="'+s+'" class="p-4 text-sm font-mono leading-relaxed w-max min-w-full text-gray-50"><code>'+a+"</code></pre></div></div>";return t.push(r),"###CODE_BLOCK_"+(t.length-1)+"###"}))).replace(/`([^`]+)`/g,'<code class="bg-white/20 px-1.5 py-0.5 rounded text-white font-bold font-mono text-sm border border-white/10">$1</code>')).replace(/\*\*(.*?)\*\*/g,'<strong class="font-semibold">$1</strong>')).replace(/^###\s+(.*)$/gm,'<h3 class="text-lg font-bold mb-2 mt-4">$1</h3>')).replace(/^[\-\*]\s+(.*)$/gm,'<li class="ml-4 list-disc text-sm">$1</li>')).replace(/^##\s+(.*)$/gm,'<b class="font-bold text-base">$1</b>')).replace(/\n/g,"<br>"),t.forEach(((t,o)=>{e=e.replace("###CODE_BLOCK_"+o+"###",t)})),e}window.currentImagePrompt="",window.openPreview=function(e){const t=document.getElementById("img-preview-container"),o=document.getElementById("preview-img"),n=document.getElementById("app-container"),a=document.getElementById("welcome-msg"),s=document.getElementById("center-app-name");t&&o&&(e.startsWith("blob:")||e.startsWith("data:")||e.startsWith("http")?o.src=e:o.src=`data:image/jpeg;base64,${e}`,t.style.setProperty("display","block","important"),t.classList.add("active"),n&&n.style.setProperty("display","none","important"),a&&a.style.setProperty("display","none","important"),s&&s.style.setProperty("display","none","important"))},window.closePreview=function(){const e=document.getElementById("img-preview-container"),t=document.getElementById("app-container"),o=document.getElementById("welcome-msg"),n=document.getElementById("center-app-name");e&&(e.classList.remove("active"),e.style.setProperty("display","none","important")),t&&(t.style.setProperty("display","block","important"),t.style.opacity="1"),o&&o.style.setProperty("display","block","important"),n&&(n.style.setProperty("display","block","important"),n.style.opacity="1");const a=new URL(window.location.href);a.searchParams.get("v")&&(a.searchParams.delete("v"),window.history.pushState({},"",a.pathname))},window.extractedCodes=[],window.openFullEditor=function(e){const t=document.getElementById(e);if(t){const e=t.innerText;document.getElementById("code-editor").value=e,document.getElementById("right-panel").classList.add("mobile-active"),document.getElementById("code-tabs").innerHTML='<button class="px-3 py-1.5 text-xs rounded-md transition font-mono font-bold">Current Code</button>',document.body.classList.contains("mode-code")||document.body.classList.add("mode-code")}},window.closeFullEditor=function(){document.getElementById("right-panel").classList.remove("mobile-active")};let codeFiles=[],activeFileIndex=0;function updateCodePanel(e){const t=[...e.matchAll(/```(\w+)?\s*([\s\S]*?)(?:```|$)/g)];0!==t.length&&(codeFiles=t.map(((e,t)=>({lang:e[1]||"Text",content:e[2],name:`File ${t+1} (${e[1]||"txt"})`}))),renderCodeTabs())}function renderCodeTabs(){const e=document.getElementById("code-tabs"),t=document.getElementById("code-editor");e&&(e.innerHTML="",codeFiles&&0!==codeFiles.length?(codeFiles.forEach(((t,o)=>{const n=document.createElement("button");n.type="button";const a=o===activeFileIndex;let s="relative z-20 px-3 py-1.5 text-xs rounded-md transition font-mono cursor-pointer border select-none mr-1 ";n.className=a?s+"bg-blue-500/20 border-blue-500/50 text-blue-200 font-bold shadow-sm":s+"border-transparent text-gray-400 hover:text-gray-100 hover:bg-white/5",n.innerText=t.name,n.onclick=e=>{e.preventDefault(),e.stopPropagation(),window.switchCodeFile(o)},e.appendChild(n)})),t&&codeFiles[activeFileIndex]&&t.value!==codeFiles[activeFileIndex].content&&(t.value=codeFiles[activeFileIndex].content)):e.innerHTML='<span class="text-[10px] text-gray-500 px-2 select-none">No files</span>')}function switchTab(e){activeFileIndex=e,renderCodeTabs();const t=document.getElementById("code-editor");t&&codeFiles[e]&&(t.value=codeFiles[e].content)}function switchTab(e){activeFileIndex=e,renderCodeTabs();const t=document.getElementById("code-editor");codeFiles[e]&&(t.value=codeFiles[e].content)}function switchTab(e){activeFileIndex=e,renderCodeTabs();const t=document.getElementById("code-editor");codeFiles[e]&&(t.value=codeFiles[e].content)}function resetChat(){isGenerating&&stopGeneration(),chatHistory=[],codeFiles=[],activeFileIndex=0;const e=document.getElementById("chat-box");e.style.display="flex",e.style.flexDirection="column",e.style.justifyContent="normal",e.innerHTML="";const t=new URLSearchParams(window.location.search).get("v"),o=document.createElement("div");o.id="welcome-msg",o.className="self-start bg-white/30 text-gray-200 px-4 py-2 rounded-2xl rounded-tl-sm max-w-[85%] mb-2 text-sm break-words animate-pulse-slow w-fit",o.style.marginTop="auto",o.style.display="block",o.innerText=t?"How can I help?":T.welcome,e.appendChild(o),document.getElementById("code-tabs").innerHTML='<span class="text-xs text-gray-500 px-2">Waiting...</span>',document.getElementById("code-editor").value="",document.body.classList.remove("started"),document.body.classList.remove("mode-code"),isStarted=!1,document.getElementById("custom-scrollbar").style.display="none",activeApp&&exitAppMode(),isMenuOpen&&toggleStoreMenu(),document.getElementById("prompt-input").value="",setMode("chat"),showToast("Chat Reset Completed")}async function processBlogImages(e){if(!e)return;let t=e.innerHTML;const o=[...t.matchAll(/\[\[IMG:\s*(.*?)\]\]/g)];if(0===o.length)return;const n="img-loader-"+Date.now(),a=document.createElement("div");a.id=n,a.className="text-xs text-gray-500 mt-2 flex items-center gap-2 animate-pulse",a.innerHTML='<i class="ri-image-line"></i> Searching related images...',e.appendChild(a);for(const e of o){const o=e[0],n=e[1].trim();let a="",s="";try{const e=await fetch(`?action=pixabay_search&q=${encodeURIComponent(n)}`),t=await e.json();if(t.hits&&t.hits.length>0){const e=t.hits[0];a=e.webformatURL,s=`<div class="text-[10px] text-gray-500 mt-1 text-center">Image by <a href="${e.pageURL}" target="_blank" class="underline">${e.user}</a> from Pixabay</div>`}}catch(e){}const i=`\n            <div class="my-6 rounded-xl overflow-hidden shadow-lg border border-white/10 group relative bg-black/20">\n                <img src="${a}" alt="${n}" class="w-full h-auto object-cover transition transform group-hover:scale-105 duration-700 min-h-[200px]" loading="lazy" onload="scrollBottom()">\n                ${s}\n                <button onclick="openPreview('${a}')" class="absolute top-2 right-2 bg-black/50 text-white p-1.5 rounded-full opacity-0 group-hover:opacity-100 transition backdrop-blur-sm"><i class="ri-fullscreen-line"></i></button>\n            </div>\n        `;t=t.replace(o,i)}e.innerHTML=t;const s=document.getElementById(n);s&&s.remove(),scrollBottom()}window.switchCodeFile=function(e){activeFileIndex=e,renderCodeTabs();const t=document.getElementById("code-editor");t&&codeFiles[e]&&(t.value=codeFiles[e].content)},document.getElementById("code-editor").addEventListener("input",(function(e){!isGenerating&&codeFiles[activeFileIndex]&&(codeFiles[activeFileIndex].content=e.target.value)}));